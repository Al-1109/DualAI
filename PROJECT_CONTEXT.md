# Контекст проекта DualAI

## История и эволюция проекта
- Изначально проект был размещен на VPS (Windows Server)
- Был создан Telegram канал и бот mirasol_estate_bot для работы с недвижимостью
- Позже создан тестовый бот @Mirasol_test_bot для разработки и миграции на Vercel

## Текущее состояние
- Проект мигрирует с VPS на Vercel
- Создан рабочий Telegram бот @Mirasol_test_bot
- Разработка ведется в ветке feature/stable-vercel
- Доступны два режима работы бота:
  1. Long Polling (локально, через `test_bot.py`) - полностью рабочий режим
  2. Webhook (на Vercel, через `api/webhook.py`) - в процессе отладки

## Архитектура
- **Telegram бот** - основной интерфейс для пользователей
- **Vercel** - хостинг для серверлесс-функций, API и webhook
- **GitHub** - хранение кода и CI/CD

## Технологии
- Python 3.13
- python-telegram-bot (для long polling)
- FastAPI (для webhook на Vercel)
- Vercel Serverless Functions

## Окружение разработки
- Локальная разработка: виртуальное окружение Python
- Тестирование: запуск `test_bot.py` с переменной окружения TEST_TELEGRAM_BOT_TOKEN
- Деплой: автоматический при push в GitHub (интеграция с Vercel)

## Взаимодействие компонентов
1. Пользователь отправляет сообщение боту в Telegram
2. В режиме long polling: Python-скрипт получает обновление через Telegram API
3. В режиме webhook: Telegram отправляет POST-запрос на URL бота на Vercel
4. Бот обрабатывает сообщение и отправляет ответ пользователю
5. Пользователь может использовать inline-клавиатуру для навигации

## Особенности и ограничения
- Webhook на Vercel имеет ограничения по времени выполнения (10-15 секунд)
- Long polling более надежен для разработки и тестирования
- Все переменные окружения должны быть установлены в Vercel для продакшена

## Ключевая проблема текущей архитектуры
- **Несовместимость Vercel с long-polling ботами:**
  - Vercel использует serverless-архитектуру, где функции имеют ограниченное время выполнения (10-60 секунд)
  - Long-polling боты требуют постоянно работающего процесса, что противоречит модели Vercel
  - Vercel автоматически завершает долго работающие процессы после таймаута
  - На Vercel подходит только webhook-подход, но не long-polling

## Возможные решения
1. **Продолжать использовать Vercel:**
   - Полностью переключиться на webhook-подход
   - Отказаться от long-polling
   - Разработать более надежную систему webhook-обработчиков

2. **Перейти на альтернативный хостинг:**
   - Render.com, Railway.app, DigitalOcean, Heroku
   - Эти платформы поддерживают постоянно работающие процессы
   - Возможность использовать long-polling или webhook по выбору

3. **Гибридное решение:**
   - Локальная разработка через long-polling
   - Продакшен на Vercel через webhook
   - Две версии бота с общим ядром логики

## Ключевые файлы
- `test_bot.py` - Рабочий бот с long polling для локального запуска
- `api/webhook.py` - Webhook для Vercel
- `watchdog_bot.py` - Скрипт для автоматического перезапуска бота (работает только локально)
- `PROJECT_STATUS.md` - Текущий статус проекта
- `PROJECT_CONTEXT.md` - Этот файл с контекстом проекта

## Текущие задачи и проблемы
- Настройка endpoint'ов и webhook'ов для Vercel
- Проблемы с деплоем на Vercel (все текущие попытки неудачные)
- Реализация интеграции с OpenAI API для обработки естественного языка
- Разработка схемы базы данных SQLite для хранения объектов недвижимости
- Разработка базовых административных функций
- Разработка системы управления объектами недвижимости

## Telegram-ресурсы
- Основной канал:
  - Название: New Age Realty
  - Username/ссылка: @New_Age_Realty
  - Описание: "Revolutionizing Real Estate in the World with Cutting-Edge Technology. Discover exclusive property listings, smart insights, and seamless transactions — your future home is just a click away!"
  - Подписчики: 2
  - Администраторы: 2
- Основной бот: @newage_realty_bot (используется на VPS)
- Тестовый бот: mirasol_test (используется для Vercel)

## Доступы и API
- **Telegram API**:
  - Основной бот (mirasol_estate_bot): настроен, токен в .env (переменная TELEGRAM_BOT_TOKEN)
  - Тестовый бот (mirasol_test): настроен, токен в .env (переменная TEST_TELEGRAM_BOT_TOKEN)
  - Доступ к каналу @MirasolEstate: настроен через переменную CHANNEL_ID в .env
  - Административный доступ: ID администратора в .env (переменная ADMIN_ID)

- **OpenAI API**:
  - Доступ через переменную OPENAI_API_KEY в .env
  - Планируется использование моделей GPT-3.5 или GPT-4
  - Файл openai_connector.py пока пуст и требует реализации
  - Статус: Настроен, но интеграция не завершена

- **Vercel**:
  - Проект настроен, информация в директории .vercel/
  - Webhook Secret в .env (переменная TEST_WEBHOOK_SECRET)
  - Среда: preview (переменная VERCEL_ENV)

## Инструкции по настройке среды разработки
1. Клонировать репозиторий
2. Создать виртуальное окружение Python: `python -m venv venv`
3. Активировать окружение:
   - Windows: `venv\Scripts\activate`
   - Unix/MacOS: `source venv/bin/activate`
4. Установить зависимости: `pip install -r requirements.txt`
5. Создать файл .env с необходимыми переменными окружения
6. Запустить бота: `python bot.py`

## Процесс обновления документации
- Файлы PROJECT_CONTEXT.md, DUALAI_DEVELOPMENT.md и PROJECT_STATUS.md должны обновляться при любых значимых изменениях в проекте
- Обновления должны отражать текущее состояние проекта, планы и проблемы
- При обновлении ветки main, документация должна быть актуализирована в первую очередь

## Полезные внешние ресурсы
- [Документация python-telegram-bot](https://docs.python-telegram-bot.org/)
- [Документация OpenAI API](https://platform.openai.com/docs/api-reference)
- [Документация Vercel](https://vercel.com/docs)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [Telegram Mini Apps](https://core.telegram.org/bots/webapps)

## Ключевые документы
- **DUALAI_DEVELOPMENT.md** - содержит полное описание архитектуры проекта, планируемые функции, технические требования и детали реализации. **Обязательно прочитать для понимания общей архитектуры.**
- **PROJECT_STATUS.md** - содержит актуальную информацию о текущем состоянии проекта, прогрессе разработки и ближайших планах. **Обязательно прочитать для понимания текущего статуса.**

## Ключевые файлы кода
- bot.py - основной файл бота
- utils.py - утилиты для работы с сообщениями
- handlers/client.py - обработчики клиентского режима
- handlers/admin.py - обработчики административного режима (в разработке)
- database.py - управление базой данных (в разработке)
- openai_connector.py - интеграция с OpenAI API (в разработке)
- .env - ключи и токены для API

## Ближайшие планы
- Завершение фазы 1 (Базовая инфраструктура)
- Переход к фазе 2 (Ядро системы) с фокусом на разработку механизма переключения между режимами
- Тестирование базовой функциональности с реальными пользователями

## Примечание по контексту
Этот файл контекста, а также DUALAI_DEVELOPMENT.md и PROJECT_STATUS.md должны регулярно обновляться, чтобы отражать актуальное состояние проекта. При начале работы с проектом следует в первую очередь ознакомиться с этими тремя документами.

## Инструкции для ИИ-ассистентов
При работе с проектом DualAI, следует:
1. В начале сеанса прочитать PROJECT_CONTEXT.md, DUALAI_DEVELOPMENT.md и PROJECT_STATUS.md
2. Учитывать текущее состояние проекта и нерешенные проблемы
3. Предлагать решения, соответствующие архитектуре проекта
4. Обращать особое внимание на проблемы с деплоем на Vercel
5. При необходимости обновлять документацию для отражения новых решений и идей 

## Инструкции для выполнения деплоя на Vercel
1. Выполнить деплой на Vercel:
   ```
   vercel --prod
   ```

2. Настроить webhook в Telegram:
   ```
   python set_webhook.py --url https://[ваш-проект].vercel.app/webhook
   ```

3. Проверить работу webhook:
   - Отправить сообщение боту
   - Проверить логи на Vercel 

## Инструкции для тестирования бота
1. **Запуск бота**:
   - Выполните команду выше в терминале
   - Дождитесь сообщения "Логирование настроено успешно" и "Запуск бота в режиме long polling"
   - Бот начнет работать и ожидать сообщения

2. **Очистка истории в Telegram**:
   - Откройте Telegram
   - Перейдите в чат с ботом @Mirasol_test_bot
   - Нажмите на три точки в правом верхнем углу
   - Выберите "Очистить историю"
   - Подтвердите действие

3. **Тестирование бота**:
   - Отправьте команду `/start` в чат с ботом
   - Бот должен ответить приветственным сообщением с кнопками
   - Нажмите на кнопку "Тест" - бот должен ответить сообщением и предложить вернуться в меню
   - Нажмите "Назад в меню" - бот должен отобразить главное меню
   - Попробуйте нажать на "О боте" - бот должен отправить информацию о себе

4. **Проверка устойчивости**:
   - Отправьте команду `/status` для проверки статистики бота
   - Оставьте комментарий, если возникнут какие-либо вопросы или проблемы 

## Инструкции для тестирования бота
1. **Запуск бота**:
   - Выполните команду выше в терминале
   - Дождитесь сообщения "Логирование настроено успешно" и "Запуск бота в режиме long polling"
   - Бот начнет работать и ожидать сообщения

2. **Очистка истории в Telegram**:
   - Откройте Telegram
   - Перейдите в чат с ботом @Mirasol_test_bot
   - Нажмите на три точки в правом верхнем углу
   - Выберите "Очистить историю"
   - Подтвердите действие

3. **Тестирование бота**:
   - Отправьте команду `/start` в чат с ботом
   - Бот должен ответить приветственным сообщением с кнопками
   - Нажмите на кнопку "Тест" - бот должен ответить сообщением и предложить вернуться в меню
   - Нажмите "Назад в меню" - бот должен отобразить главное меню
   - Попробуйте нажать на "О боте" - бот должен отправить информацию о себе

4. **Проверка устойчивости**:
   - Отправьте команду `/status` для проверки статистики бота
   - Оставьте комментарий, если возникнут какие-либо вопросы или проблемы 