# Контекст проекта DualAI

## История и эволюция проекта
- Изначально проект был размещен на VPS (Windows Server)
- Был создан Telegram канал и бот mirasol_estate_bot для работы с недвижимостью
- Позже создан тестовый бот @Mirasol_test_bot для разработки и миграции на Vercel
- В настоящее время идет процесс возврата к VPS решению с long polling для обхода ограничений webhook

## Текущее состояние
- Проект имеет две функционирующие версии:
  1. Webhook на Vercel через `api/webhook.js` - стабильно работает, но имеет ограничения интерфейса
  2. Long Polling (локально, через `test_bot.py`) - для разработки и тестирования
- Разрабатывается третья версия для Windows VPS с long polling
- Доступны два режима работы бота:
  1. Long Polling (локально и на VPS) - более гибкое взаимодействие с пользователем
  2. Webhook (на Vercel, через `api/webhook.js`) - для промышленной эксплуатации

## Текущий этап: Возврат к VPS с Long Polling
- Подготовлены скрипты для развертывания на Windows VPS:
  - `vps_bot.py` - основной бот с long polling
  - `windows_bot_runner.py` - система мониторинга и автоматического перезапуска
  - `setup_and_run_bot.bat` - скрипт настройки и запуска бота
  - `install_as_service.bat` - установка бота как службы Windows
- Подготовлена документация `WINDOWS_VPS_SETUP.md` с инструкциями по установке
- VPS доступен по адресу 65.21.73.61:30596 с логином AdmVps
- Для подключения используется Remote Desktop Protocol (RDP)

## Архитектура
- **Telegram бот** - основной интерфейс для пользователей
- **Vercel** - хостинг для серверлесс-функций, API и webhook
- **Windows VPS** - хостинг для long polling бота с улучшенным пользовательским интерфейсом
- **GitHub** - хранение кода и CI/CD
- **JavaScript** - основной язык для webhook-обработчиков на Vercel
- **Python** - используется для локальной разработки, тестирования и long polling на VPS

## Технологии
- Python 3.13 (локальная разработка и VPS)
- Node.js (Vercel serverless functions)
- python-telegram-bot (для long polling)
- Vercel Serverless Functions (JavaScript)
- HTTPS API (для webhook на Vercel)
- Windows Services (для стабильной работы на VPS)

## Окружение разработки
- Локальная разработка: виртуальное окружение Python, long polling через `test_bot.py`
- Тестирование: запуск `test_bot.py` с переменной окружения TEST_TELEGRAM_BOT_TOKEN
- Деплой: автоматический при push в GitHub (интеграция с Vercel)
- Продакшен: webhook на Vercel через `api/webhook.js` и/или long polling на VPS

## Взаимодействие компонентов
1. Пользователь отправляет сообщение боту в Telegram
2. В режиме long polling (локально или на VPS): Python-скрипт получает обновление через Telegram API
3. В режиме webhook (Vercel): Telegram отправляет POST-запрос на URL бота на Vercel
4. Бот обрабатывает сообщение и отправляет ответ пользователю
5. Пользователь может использовать inline-клавиатуру для навигации

## Особенности и ограничения
- Webhook на Vercel имеет ограничения по времени выполнения (10-15 секунд)
- Long polling более надежен и гибок в управлении интерфейсом, но требует VPS
- На VPS бот оформляется как служба Windows для стабильной работы 24/7
- Для обеспечения отказоустойчивости на VPS используются скрипты мониторинга и автоперезапуска

## Решенные проблемы
- **Несовместимость Vercel с long-polling ботами** - решена через использование webhook-подхода на JavaScript
- **Проблемы с Python webhook на Vercel** - решены через переход на JavaScript
- **Проблемы с маршрутизацией API** - решены через корректную настройку vercel.json
- **Верификация запросов от Telegram** - реализована с использованием secret_token
- **Ограничения webhook для интерфейса** - решаются через возврат к long polling на VPS

## Ключевые файлы
- `test_bot.py` - Рабочий бот с long polling для локального запуска
- `vps_bot.py` - Бот с long polling для Windows VPS
- `windows_bot_runner.py` - Система мониторинга для Windows VPS
- `api/webhook.js` - JavaScript webhook для Vercel
- `vercel.json` - Конфигурация маршрутизации и сборки для Vercel
- `watchdog_bot.py` - Скрипт для автоматического перезапуска бота (работает только локально)
- `set_webhook.py` - Утилита для управления webhook в Telegram API
- `PROJECT_STATUS.md` - Текущий статус проекта
- `PROJECT_CONTEXT.md` - Этот файл с контекстом проекта
- `WINDOWS_VPS_SETUP.md` - Инструкция по настройке Windows VPS

## Текущая архитектура развертывания
1. **Локальная разработка**:
   - Long polling через `test_bot.py`
   - Мониторинг и автоперезапуск через `watchdog_bot.py`
   - Отладка и тестирование новых функций

2. **Vercel (продакшен)**:
   - JavaScript webhook через `api/webhook.js`
   - Serverless функции с ограниченным временем выполнения
   - Масштабируемое решение без необходимости поддержки постоянно работающего процесса
   - Верификация запросов от Telegram через secret_token

3. **Windows VPS (в процессе настройки)**:
   - Long polling через `vps_bot.py`
   - Мониторинг и автоперезапуск через `windows_bot_runner.py`
   - Оформление как службы Windows для стабильной работы
   - Улучшенный пользовательский интерфейс благодаря long polling

## Ключевые выводы исследования
1. Vercel принципиально несовместим с long-polling ботами из-за ограничений serverless-архитектуры
2. Для работы Telegram бота на Vercel необходимо использовать webhook-подход
3. JavaScript более предпочтителен для serverless функций на Vercel, чем Python
4. Корректная настройка vercel.json критически важна для работы API
5. Webhook предоставляет большую масштабируемость, но long polling дает лучший контроль над интерфейсом
6. VPS с Windows Service - оптимальное решение для long polling бота в продакшене

## Текущие задачи и проблемы
- Подключение к Windows VPS и настройка long polling бота
- Тестирование службы Windows для запуска бота
- Сравнение пользовательского опыта webhook и long polling версий
- Изучение возможностей Telegram Mini App как альтернативы для улучшения UI
- Разработка стратегии перехода от webhook к выбранному решению

## Telegram-ресурсы
- Основной канал:
  - Название: New Age Realty
  - Username/ссылка: @New_Age_Realty
  - Описание: "Revolutionizing Real Estate in the World with Cutting-Edge Technology. Discover exclusive property listings, smart insights, and seamless transactions — your future home is just a click away!"
  - Подписчики: 2
  - Администраторы: 2
- Основной бот: @newage_realty_bot (используется на VPS)
- Тестовый бот: mirasol_test (используется для Vercel)

## Доступы и API
- **Telegram API**:
  - Основной бот (mirasol_estate_bot): настроен, токен в .env (переменная TELEGRAM_BOT_TOKEN)
  - Тестовый бот (mirasol_test): настроен, токен в .env (переменная TEST_TELEGRAM_BOT_TOKEN)
  - Доступ к каналу @MirasolEstate: настроен через переменную CHANNEL_ID в .env
  - Административный доступ: ID администратора в .env (переменная ADMIN_ID)

- **OpenAI API**:
  - Доступ через переменную OPENAI_API_KEY в .env
  - Планируется использование моделей GPT-3.5 или GPT-4
  - Файл openai_connector.py пока пуст и требует реализации
  - Статус: Настроен, но интеграция не завершена

- **Vercel**:
  - Проект настроен, информация в директории .vercel/
  - Webhook Secret в .env (переменная TEST_WEBHOOK_SECRET)
  - Среда: preview (переменная VERCEL_ENV)

## Инструкции по настройке среды разработки
1. Клонировать репозиторий
2. Создать виртуальное окружение Python: `python -m venv venv`
3. Активировать окружение:
   - Windows: `venv\Scripts\activate`
   - Unix/MacOS: `source venv/bin/activate`
4. Установить зависимости: `pip install -r requirements.txt`
5. Создать файл .env с необходимыми переменными окружения
6. Запустить бота: `python bot.py`

## Процесс обновления документации
- Файлы PROJECT_CONTEXT.md, DUALAI_DEVELOPMENT.md и PROJECT_STATUS.md должны обновляться при любых значимых изменениях в проекте
- Обновления должны отражать текущее состояние проекта, планы и проблемы
- При обновлении ветки main, документация должна быть актуализирована в первую очередь

## Полезные внешние ресурсы
- [Документация python-telegram-bot](https://docs.python-telegram-bot.org/)
- [Документация OpenAI API](https://platform.openai.com/docs/api-reference)
- [Документация Vercel](https://vercel.com/docs)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [Telegram Mini Apps](https://core.telegram.org/bots/webapps)

## Ключевые документы
- **DUALAI_DEVELOPMENT.md** - содержит полное описание архитектуры проекта, планируемые функции, технические требования и детали реализации. **Обязательно прочитать для понимания общей архитектуры.**
- **PROJECT_STATUS.md** - содержит актуальную информацию о текущем состоянии проекта, прогрессе разработки и ближайших планах. **Обязательно прочитать для понимания текущего статуса.**

## Ключевые файлы кода
- bot.py - основной файл бота
- utils.py - утилиты для работы с сообщениями
- handlers/client.py - обработчики клиентского режима
- handlers/admin.py - обработчики административного режима (в разработке)
- database.py - управление базой данных (в разработке)
- openai_connector.py - интеграция с OpenAI API (в разработке)
- .env - ключи и токены для API

## Ближайшие планы
- Завершение фазы 1 (Базовая инфраструктура)
- Переход к фазе 2 (Ядро системы) с фокусом на разработку механизма переключения между режимами
- Тестирование базовой функциональности с реальными пользователями

## Примечание по контексту
Этот файл контекста, а также DUALAI_DEVELOPMENT.md и PROJECT_STATUS.md должны регулярно обновляться, чтобы отражать актуальное состояние проекта. При начале работы с проектом следует в первую очередь ознакомиться с этими тремя документами.

## Инструкции для ИИ-ассистентов
При работе с проектом DualAI, следует:
1. В начале сеанса прочитать PROJECT_CONTEXT.md, DUALAI_DEVELOPMENT.md и PROJECT_STATUS.md
2. Учитывать текущее состояние проекта и нерешенные проблемы
3. Предлагать решения, соответствующие архитектуре проекта
4. Обращать особое внимание на проблемы с деплоем на Vercel
5. При необходимости обновлять документацию для отражения новых решений и идей 

## Инструкции для выполнения деплоя на Vercel
1. Выполнить деплой на Vercel:
   ```
   vercel --prod
   ```

2. Настроить webhook в Telegram:
   ```
   python set_webhook.py --url https://[ваш-проект].vercel.app/webhook
   ```

3. Проверить работу webhook:
   - Отправить сообщение боту
   - Проверить логи на Vercel 

## Инструкции для тестирования бота
1. **Запуск бота**:
   - Выполните команду выше в терминале
   - Дождитесь сообщения "Логирование настроено успешно" и "Запуск бота в режиме long polling"
   - Бот начнет работать и ожидать сообщения

2. **Очистка истории в Telegram**:
   - Откройте Telegram
   - Перейдите в чат с ботом @Mirasol_test_bot
   - Нажмите на три точки в правом верхнем углу
   - Выберите "Очистить историю"
   - Подтвердите действие

3. **Тестирование бота**:
   - Отправьте команду `/start` в чат с ботом
   - Бот должен ответить приветственным сообщением с кнопками
   - Нажмите на кнопку "Тест" - бот должен ответить сообщением и предложить вернуться в меню
   - Нажмите "Назад в меню" - бот должен отобразить главное меню
   - Попробуйте нажать на "О боте" - бот должен отправить информацию о себе

4. **Проверка устойчивости**:
   - Отправьте команду `/status` для проверки статистики бота
   - Оставьте комментарий, если возникнут какие-либо вопросы или проблемы 

## Инструкции для тестирования бота
1. **Запуск бота**:
   - Выполните команду выше в терминале
   - Дождитесь сообщения "Логирование настроено успешно" и "Запуск бота в режиме long polling"
   - Бот начнет работать и ожидать сообщения

2. **Очистка истории в Telegram**:
   - Откройте Telegram
   - Перейдите в чат с ботом @Mirasol_test_bot
   - Нажмите на три точки в правом верхнем углу
   - Выберите "Очистить историю"
   - Подтвердите действие

3. **Тестирование бота**:
   - Отправьте команду `/start` в чат с ботом
   - Бот должен ответить приветственным сообщением с кнопками
   - Нажмите на кнопку "Тест" - бот должен ответить сообщением и предложить вернуться в меню
   - Нажмите "Назад в меню" - бот должен отобразить главное меню
   - Попробуйте нажать на "О боте" - бот должен отправить информацию о себе

4. **Проверка устойчивости**:
   - Отправьте команду `/status` для проверки статистики бота
   - Оставьте комментарий, если возникнут какие-либо вопросы или проблемы 